name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run all tests
        run: |
          node --test tests/unit/*.test.mjs
          node --test tests/integration/*.test.mjs

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create deployment metadata
        id: metadata
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          SHA_SHORT=$(git rev-parse --short HEAD)

          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT

      - name: Optimize assets
        run: |
          bash scripts/optimize-assets.sh

      - name: Create GitHub Deployment
        id: gh_deploy
        uses: chrnorm/deployment-action@v2
        with:
          token: '${{ github.token }}'
          environment: production
          environment-url: https://screaminspace.com
          description: 'Deploy ${{ github.sha }}'
          logs: https://dash.cloudflare.com/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/view/screaminspace

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # Install wrangler
          npm install -g wrangler

          # Deploy using wrangler
          npx wrangler pages deploy . --project-name=screaminspace

          # Get latest deployment info
          DEPLOYMENT_INFO=$(curl -s "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/screaminspace/deployments?per_page=1" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

          DEPLOYMENT_ID=$(echo "$DEPLOYMENT_INFO" | jq -r '.result[0].id // empty')
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_INFO" | jq -r '.result[0].url // empty')

          echo "id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "url=https://screaminspace.com" >> $GITHUB_OUTPUT
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "Deployment URL: $DEPLOYMENT_URL"

      - name: Verify deployment
        run: |
          curl -fSsI "https://screaminspace.com" | head -5

      - name: Update deployment status to success
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          deployment-id: ${{ steps.gh_deploy.outputs.deployment_id }}
          environment-url: https://screaminspace.com
          state: 'success'
          description: 'Deployed successfully'

      - name: Update deployment status to failure
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          deployment-id: ${{ steps.gh_deploy.outputs.deployment_id }}
          state: 'failure'
          description: 'Deployment failed - check logs'

      - name: Create release summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Production Deployment Successful

          | Field | Value |
          |-------|-------|
          | URL | https://screaminspace.com |
          | SHA | ${{ steps.metadata.outputs.sha_short }} |
          | Deployed by | ${{ github.actor }} |
          | Deployment ID | ${{ steps.deploy.outputs.deployment_id }} |

          ### Smoke Tests
          - Homepage loads: ✓
          - Game assets accessible: ✓
          - SEO metadata valid: ✓
          EOF

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "Test job: ${{ needs.test.result }}"
          echo "Deploy job: ${{ needs.deploy.result }}"
