name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: production
  cancel-in-progress: false

jobs:
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run all tests
        run: |
          node --test tests/unit/*.test.mjs
          node --test tests/integration/*.test.mjs

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create deployment tag
        id: tag
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          SHA_SHORT=$(git rev-parse --short HEAD)
          TAG_NAME="deploy-${TIMESTAMP}-${SHA_SHORT}"

          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "sha_short=$SHA_SHORT" >> $GITHUB_OUTPUT

          git tag -a "$TAG_NAME" -m "Deployment: ${TIMESTAMP}"
          git push origin "$TAG_NAME" || echo "Tag already exists"

      - name: Optimize assets
        run: |
          bash scripts/optimize-assets.sh

      - name: Generate deployment artifacts
        run: |
          mkdir -p dist
          cp index.html 404.html robots.txt sitemap.xml dist/
          cp -r assets dist/

          # Generate deployment metadata
          cat > dist/deployment.json <<EOF
          {
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "git_tag": "${{ steps.tag.outputs.name }}",
            "deployed_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_number }}"
          }
          EOF

      - name: Create GitHub Deployment
        id: gh_deploy
        uses: chrnorm/deployment-action@v2
        with:
          token: '${{ github.token }}'
          environment: production
          environment-url: https://screaminspace.com
          description: 'Deploy ${{ steps.tag.outputs.name }}'
          logs: https://dash.cloudflare.com/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/view/screaminspace

      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          RESPONSE=$(curl -sX POST "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/screaminspace/deployments" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"branch\": \"main\",
              \"commit_hash\": \"${{ github.sha }}\",
              \"commit_message\": \"${{ github.event.head_commit.message }}\",
              \"production\": true
            }")

          DEPLOYMENT_ID=$(echo "$RESPONSE" | jq -r '.result.id // empty')
          DEPLOYMENT_URL=$(echo "$RESPONSE" | jq -r '.result.url // empty')
          STAGES_URL=$(echo "$RESPONSE" | jq -r '.result.stages_url // empty')

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "Failed to create deployment"
            echo "$RESPONSE"
            exit 1
          fi

          echo "id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "url=https://screaminspace.com" >> $GITHUB_OUTPUT
          echo "stages_url=$STAGES_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "Stages URL: $STAGES_URL"

      - name: Wait for deployment completion
        id: wait
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DEPLOYMENT_ID: ${{ steps.deploy.outputs.deployment_id }}
        run: |
          echo "Waiting for deployment ${DEPLOYMENT_ID} to complete..."
          MAX_ATTEMPTS=60
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            RESPONSE=$(curl -s "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/screaminspace/deployments/$DEPLOYMENT_ID" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN")

            STAGE=$(echo "$RESPONSE" | jq -r '.result.latest_stage.stage // empty')
            STATUS=$(echo "$RESPONSE" | jq -r '.result.latest_stage.status // empty')

            echo "Current stage: $STAGE - Status: $STATUS"

            if [ "$STATUS" = "success" ]; then
              echo "Deployment completed successfully"
              exit 0
            fi

            if [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
              echo "Deployment failed"
              echo "$RESPONSE" | jq '.result.latest_stage'
              exit 1
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done

          echo "Deployment timed out"
          exit 1

      - name: Run smoke tests
        run: |
          bash scripts/smoke-test.sh "https://screaminspace.com"

      - name: Verify deployment health
        run: |
          bash scripts/health-check.sh "https://screaminspace.com"

      - name: Update deployment status to success
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          deployment-id: ${{ steps.gh_deploy.outputs.deployment_id }}
          environment-url: https://screaminspace.com
          state: 'success'
          description: 'Deployed successfully'

      - name: Update deployment status to failure
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: '${{ github.token }}'
          deployment-id: ${{ steps.gh_deploy.outputs.deployment-id }}
          state: 'failure'
          description: 'Deployment failed - check logs'

      - name: Rollback on failure
        if: failure()
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          bash scripts/rollback.sh production

      - name: Create release summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## Production Deployment Successful

          | Field | Value |
          |-------|-------|
          | URL | https://screaminspace.com |
          | Tag | ${{ steps.tag.outputs.name }} |
          | SHA | ${{ steps.tag.outputs.sha_short }} |
          | Deployed by | ${{ github.actor }} |
          | Deployment ID | ${{ steps.deploy.outputs.deployment_id }} |

          ### Smoke Tests
          - Homepage loads: ✓
          - Game assets accessible: ✓
          - SEO metadata valid: ✓
          EOF

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "Test job: ${{ needs.test.result }}"
          echo "Deploy job: ${{ needs.deploy.result }}"
